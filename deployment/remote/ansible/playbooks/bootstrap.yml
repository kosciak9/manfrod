---
# Bootstrap playbook for fresh Arch Linux ARM installation
#
# This playbook ONLY sets up:
# 1. Installs sudo
# 2. Creates kosciak user with SSH key
# 3. Creates manfrod user with password
# 4. Configures sudo for wheel group
# 5. Hardens SSH (disables root, password auth, allows only kosciak)
# 6. Locks alarm user
#
# After bootstrap, update inventory and run site.yml for everything else.
#
# Run with:
#   ansible-playbook playbooks/bootstrap.yml

- name: Bootstrap Arch Linux ARM
  hosts: bootstrap
  gather_facts: false
  become: true

  pre_tasks:
    # Fresh Arch ARM has no Python - install it first with raw commands
    - name: Initialize pacman keyring (raw)
      ansible.builtin.raw: pacman-key --init
      changed_when: false

    - name: Populate Arch Linux ARM keyring (raw)
      ansible.builtin.raw: pacman-key --populate archlinuxarm
      changed_when: false

    - name: Install python and sudo (raw)
      ansible.builtin.raw: pacman -Sy --noconfirm python sudo
      changed_when: false

    - name: Gather facts
      ansible.builtin.setup:

  tasks:

    # =========================================================================
    # User Management
    # =========================================================================

    - name: Create admin user ({{ admin_user }})
      ansible.builtin.user:
        name: "{{ admin_user }}"
        groups: wheel
        append: true
        create_home: true
        shell: /bin/bash
        state: present

    - name: Set up SSH authorized keys for admin user
      ansible.posix.authorized_key:
        user: "{{ admin_user }}"
        key: "{{ admin_ssh_pubkey }}"
        state: present
        exclusive: true

    - name: Create app user ({{ app_user }})
      ansible.builtin.user:
        name: "{{ app_user }}"
        groups: wheel
        append: true
        create_home: true
        shell: /bin/bash
        password: "{{ vault_manfrod_password | password_hash('sha512') }}"
        state: present

    # =========================================================================
    # Sudo Configuration
    # =========================================================================

    - name: Allow wheel group to use sudo without password
      ansible.builtin.copy:
        content: "%wheel ALL=(ALL:ALL) NOPASSWD: ALL\n"
        dest: /etc/sudoers.d/wheel
        mode: '0440'
        validate: 'visudo -cf %s'

    # =========================================================================
    # SSH Hardening
    # =========================================================================

    - name: Configure SSH - disable root login
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitRootLogin'
        line: 'PermitRootLogin no'
      notify: Restart sshd

    - name: Configure SSH - disable password authentication
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication'
        line: 'PasswordAuthentication no'
      notify: Restart sshd

    - name: Configure SSH - allow only admin user
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?AllowUsers'
        line: 'AllowUsers {{ admin_user }}'
      notify: Restart sshd

    - name: Configure SSH - disable empty passwords
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitEmptyPasswords'
        line: 'PermitEmptyPasswords no'
      notify: Restart sshd

    # =========================================================================
    # Disable Default Users
    # =========================================================================

    - name: Lock alarm user account
      ansible.builtin.user:
        name: alarm
        password_lock: true
        shell: /usr/sbin/nologin

    - name: Change root password
      ansible.builtin.user:
        name: root
        password: "{{ vault_root_password | password_hash('sha512') }}"

  handlers:
    - name: Restart sshd
      ansible.builtin.systemd:
        name: sshd
        state: restarted

  post_tasks:
    - name: Display bootstrap completion message
      ansible.builtin.debug:
        msg: |
          ========================================
          Bootstrap complete!
          ========================================
          
          Next steps:
          1. Update inventory/hosts.yml:
             - Change ansible_user to '{{ admin_user }}'
             - Remove ansible_password, ansible_become_method, ansible_become_password
             - Add: ansible_become_method: sudo
             - Move lissandra from 'bootstrap' to 'configured' group
          
          2. Test SSH access:
             ssh {{ admin_user }}@{{ ansible_host }}
          
          3. Run the main site playbook:
             ansible-playbook playbooks/site.yml
          
          ========================================
