---
# Main site playbook for Manfrod deployment
#
# This playbook:
# 1. Installs and configures Podman
# 2. Sets up ParadeDB container with persistent storage
# 3. Creates systemd service for ParadeDB
# 4. Installs and configures Tailscale
# 5. Configures firewall (optional)
#
# Prerequisites:
# - Bootstrap playbook has been run
# - inventory/hosts.yml updated to use kosciak user
#
# Run with:
#   ansible-playbook playbooks/site.yml --vault-password-file .vault_pass

- name: Configure Manfrod server
  hosts: configured
  gather_facts: true

  tasks:
    # =========================================================================
    # System Configuration
    # =========================================================================

    - name: Set hostname
      ansible.builtin.copy:
        content: "{{ hostname }}\n"
        dest: /etc/hostname
        mode: "0644"
      become: true
      notify: Apply hostname

    - name: Update /etc/hosts with hostname
      ansible.builtin.lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1'
        line: "127.0.1.1\t{{ hostname }}"
        insertafter: '^127\.0\.0\.1'
      become: true

    - name: Set timezone
      community.general.timezone:
        name: "{{ timezone }}"
      become: true

    - name: Install base packages
      community.general.pacman:
        name: "{{ base_packages }}"
        state: present
        update_cache: true
      become: true

    # =========================================================================
    # WiFi Configuration (wpa_supplicant)
    # =========================================================================

    - name: Install wireless tools
      community.general.pacman:
        name:
          - wpa_supplicant
          - wireless-regdb
        state: present
      become: true

    - name: Create wpa_supplicant configuration directory
      ansible.builtin.file:
        path: /etc/wpa_supplicant
        state: directory
        mode: '0755'
      become: true

    - name: Configure wpa_supplicant for wlan0
      ansible.builtin.copy:
        content: |
          ctrl_interface=/run/wpa_supplicant
          ctrl_interface_group=wheel
          sae_pwe=2
          
          network={
              ssid="{{ vault_wifi_ssid }}"
              psk="{{ vault_wifi_password }}"
              key_mgmt=SAE
              ieee80211w=2
          }
        dest: /etc/wpa_supplicant/wpa_supplicant-wlan0.conf
        mode: '0600'
      become: true
      notify: Restart wpa_supplicant

    - name: Enable and start wpa_supplicant for wlan0
      ansible.builtin.systemd:
        name: wpa_supplicant@wlan0
        state: started
        enabled: true
      become: true

    - name: Create networkd config for wlan0
      ansible.builtin.copy:
        content: |
          [Match]
          Name=wlan0

          [Network]
          DHCP=yes
        dest: /etc/systemd/network/25-wlan0.network
        mode: "0644"
      become: true
      notify: Restart networkd

    - name: Create networkd config for ethernet
      ansible.builtin.copy:
        content: |
          [Match]
          Name=en*

          [Network]
          DHCP=yes
        dest: /etc/systemd/network/20-wired.network
        mode: "0644"
      become: true
      notify: Restart networkd

    - name: Link resolv.conf to systemd-resolved
      ansible.builtin.file:
        src: /run/systemd/resolve/stub-resolv.conf
        dest: /etc/resolv.conf
        state: link
        force: true
      become: true

    - name: Enable systemd-networkd
      ansible.builtin.systemd:
        name: systemd-networkd
        state: started
        enabled: true
      become: true

    - name: Enable systemd-resolved
      ansible.builtin.systemd:
        name: systemd-resolved
        state: started
        enabled: true
      become: true

    # =========================================================================
    # Podman Installation
    # =========================================================================

    - name: Install Podman and container tools
      community.general.pacman:
        name: "{{ podman_packages }}"
        state: present
        update_cache: true
      become: true

    - name: Install shadow package (for newuidmap/newgidmap)
      community.general.pacman:
        name: shadow
        state: present
      become: true

    - name: Set capabilities on newuidmap
      community.general.capabilities:
        path: /usr/bin/newuidmap
        capability: cap_setuid+ep
        state: present
      become: true

    - name: Set capabilities on newgidmap
      community.general.capabilities:
        path: /usr/bin/newgidmap
        capability: cap_setgid+ep
        state: present

      become: true

    - name: Configure subuid for app user
      ansible.builtin.lineinfile:
        path: /etc/subuid
        regexp: "^{{ app_user }}:"
        line: "{{ app_user }}:231072:65536"
        create: true
        mode: "0644"
      become: true

    - name: Configure subgid for app user
      ansible.builtin.lineinfile:
        path: /etc/subgid
        regexp: "^{{ app_user }}:"
        line: "{{ app_user }}:231072:65536"
        create: true
        mode: "0644"
      become: true

    - name: Enable lingering for manfrod user (required for user services without login)
      ansible.builtin.command: loginctl enable-linger {{ app_user }}
      become: true
      register: linger_result
      changed_when: linger_result.rc == 0

    # =========================================================================
    # TUN Module (required for Tailscale)
    # =========================================================================

    - name: Ensure TUN module is loaded
      community.general.modprobe:
        name: tun
        state: present
      become: true

    - name: Persist TUN module loading at boot
      ansible.builtin.copy:
        content: "tun\n"
        dest: /etc/modules-load.d/tun.conf
        mode: "0644"
      become: true

    # =========================================================================
    # ParadeDB Container Setup
    # =========================================================================

    - name: Create /etc/manfrod config directory
      ansible.builtin.file:
        path: /etc/manfrod
        state: directory
        owner: root
        group: root
        mode: "0755"
      become: true

    - name: Deploy ParadeDB environment file
      ansible.builtin.template:
        src: ../templates/paradedb.env.j2
        dest: /etc/manfrod/paradedb.env
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0600"
      become: true
      notify: Restart paradedb

    - name: Create ParadeDB podman volume
      containers.podman.podman_volume:
        name: "{{ paradedb_volume_name }}"
        state: present
      become: true
      become_user: "{{ app_user }}"

    - name: Deploy ParadeDB systemd service
      ansible.builtin.template:
        src: ../templates/paradedb.service.j2
        dest: /etc/systemd/system/paradedb.service
        mode: "0644"
      become: true
      notify: Restart paradedb

    - name: Enable and start ParadeDB service
      ansible.builtin.systemd:
        name: paradedb
        state: started
        enabled: true
        daemon_reload: true
      become: true

    # =========================================================================
    # Elixir Toolchain Setup
    # =========================================================================

    - name: Install Hex package manager
      ansible.builtin.command: mix local.hex --force
      become: true
      become_user: "{{ app_user }}"
      register: hex_install
      changed_when: "'* creating' in hex_install.stdout"

    - name: Install Rebar build tool
      ansible.builtin.command: mix local.rebar --force
      become: true
      become_user: "{{ app_user }}"
      register: rebar_install
      changed_when: "'* creating' in rebar_install.stdout"

    # =========================================================================
    # Manfrod Application Deployment
    # =========================================================================

    - name: Create application directory
      ansible.builtin.file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0755"
      become: true

    - name: Sync Manfrod code
      ansible.posix.synchronize:
        src: "{{ playbook_dir }}/../../../../"
        dest: "{{ app_dir }}/"
        delete: true
        rsync_opts:
          - "--exclude=.git"
          - "--exclude=_build"
          - "--exclude=deps"
          - "--exclude=.elixir_ls"
          - "--exclude=deployment/remote/ansible/.vault_pass"
      become: true
      become_user: "{{ app_user }}"
      notify: Restart manfrod

    - name: Deploy .env file
      ansible.builtin.template:
        src: ../templates/env.j2
        dest: "{{ app_dir }}/.env"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0600"
      become: true
      notify: Restart manfrod

    - name: Install Elixir dependencies
      ansible.builtin.command: mix deps.get
      args:
        chdir: "{{ app_dir }}"
      become: true
      become_user: "{{ app_user }}"
      register: deps_get
      changed_when: "'New' in deps_get.stdout or 'Resolving' in deps_get.stdout"

    - name: Compile application
      ansible.builtin.command: mix compile
      args:
        chdir: "{{ app_dir }}"
      become: true
      become_user: "{{ app_user }}"
      register: compile_result
      changed_when: "'Compiling' in compile_result.stdout"

    - name: Run database migrations
      ansible.builtin.command: mix ecto.migrate
      args:
        chdir: "{{ app_dir }}"
      become: true
      become_user: "{{ app_user }}"
      register: migrate_result
      changed_when: "'migrated' in migrate_result.stdout"

    - name: Deploy Manfrod systemd service
      ansible.builtin.template:
        src: ../templates/manfrod.service.j2
        dest: /etc/systemd/system/manfrod.service
        mode: "0644"
      become: true
      notify: Restart manfrod

    - name: Enable and start Manfrod service
      ansible.builtin.systemd:
        name: manfrod
        state: started
        enabled: true
        daemon_reload: true
      become: true

    # =========================================================================
    # Tailscale Installation and Configuration
    # =========================================================================

    - name: Install Tailscale
      community.general.pacman:
        name: tailscale
        state: present
      become: true

    - name: Enable and start tailscaled service
      ansible.builtin.systemd:
        name: tailscaled
        state: started
        enabled: true
      become: true

    - name: Authenticate Tailscale with auth key
      ansible.builtin.command: >
        tailscale up
        --authkey={{ vault_tailscale_authkey }}
        {{ tailscale_args }}
        {% if tailscale_accept_dns %}--accept-dns{% endif %}
      register: tailscale_up
      changed_when: "'Success' in tailscale_up.stdout or tailscale_up.rc == 0"
      failed_when: tailscale_up.rc != 0 and 'already' not in tailscale_up.stderr
      become: true

    - name: Get Tailscale status
      ansible.builtin.command: tailscale status
      register: tailscale_status
      changed_when: false
      become: true

    - name: Display Tailscale status
      ansible.builtin.debug:
        var: tailscale_status.stdout_lines

    - name: Get Tailscale IP
      ansible.builtin.command: tailscale ip -4
      register: tailscale_ip
      changed_when: false
      become: true

    # =========================================================================
    # Firewall Configuration (optional - nftables)
    # =========================================================================

    - name: Install nftables
      community.general.pacman:
        name: nftables
        state: present
      become: true

    - name: Create nftables configuration
      ansible.builtin.copy:
        content: |
          #!/usr/sbin/nft -f

          flush ruleset

          table inet filter {
            chain input {
              type filter hook input priority 0; policy drop;
              
              # Allow established/related connections
              ct state established,related accept
              
              # Allow loopback
              iif lo accept
              
              # Allow ICMP (ping)
              ip protocol icmp accept
              ip6 nexthdr icmpv6 accept
              
              # Allow SSH (for bootstrap, can be removed after Tailscale SSH works)
              tcp dport 22 accept
              
              # Allow Tailscale interface
              iifname "tailscale0" accept
              
              # Log and drop everything else
              # log prefix "nftables drop: " drop
              drop
            }
            
            chain forward {
              type filter hook forward priority 0; policy drop;
            }
            
            chain output {
              type filter hook output priority 0; policy accept;
            }
          }
        dest: /etc/nftables.conf
        mode: "0644"
      become: true
      notify: Restart nftables

    - name: Enable nftables service
      ansible.builtin.systemd:
        name: nftables
        state: started
        enabled: true
      become: true

  handlers:
    - name: Apply hostname
      ansible.builtin.command: hostnamectl set-hostname {{ hostname }}
      become: true

    - name: Restart wpa_supplicant
      ansible.builtin.systemd:
        name: wpa_supplicant@wlan0
        state: restarted
      become: true

    - name: Restart networkd
      ansible.builtin.systemd:
        name: systemd-networkd
        state: restarted
      become: true

    - name: Restart nftables
      ansible.builtin.systemd:
        name: nftables
        state: restarted
      become: true

    - name: Restart paradedb
      ansible.builtin.systemd:
        name: paradedb
        state: restarted
        daemon_reload: true
      become: true

    - name: Restart manfrod
      ansible.builtin.systemd:
        name: manfrod
        state: restarted
        daemon_reload: true
      become: true

  post_tasks:
    - name: Display deployment summary
      ansible.builtin.debug:
        msg: |
          ========================================
          Deployment complete!
          ========================================

          Tailscale:
            - IP: {{ tailscale_ip.stdout }}
            - SSH: ssh {{ admin_user }}@{{ tailscale_ip.stdout }}
            - Or use MagicDNS: ssh {{ admin_user }}@{{ hostname }}

          Services:
            - Tailscale: systemctl status tailscaled
            - ParadeDB:  systemctl status paradedb
            - Manfrod:   systemctl status manfrod

          Application:
            - URL: http://{{ tailscale_ip.stdout }}:{{ app_port }}
            - Code: {{ app_dir }}
            - Logs: journalctl -u manfrod -f

          Next steps:
            1. Disable SSH port 22 in nftables.conf after confirming Tailscale SSH works

          ========================================
